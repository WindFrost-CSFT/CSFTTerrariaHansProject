name: Manage Release Assets

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'upload'
        type: choice
        options:
          - upload
          - delete

jobs:
  manage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Project
        uses: actions/checkout@v4

      - name: Create or Get Release
        id: release
        uses: actions/github-script@v7
        with:
          script: |
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo
            });
            let release = releases.data.find(r => r.tag_name === 'workflow-release');
            
            if (!release) {
              release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: 'workflow-release',
                name: 'Workflow Assets',
                body: '该生成内容只用于工作流使用，请勿下载',
                draft: true,
                prerelease: false
              });
              console.log('Created release:', release.data.id);
            } else {
              console.log('Found release:', release.data.id);
            }
            
            return release.data.id;

      - name: Upload Origin File
        if: github.event.inputs.action == 'upload'
        uses: actions/github-script@v7
        with:
          script: |
            const release_id = ${{ steps.release.outputs.result }};
            
            // 检查是否已存在
            const assets = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release_id
            });
            
            const existingAsset = assets.data.find(a => a.name === 'data.unity3d.origin');
            if (existingAsset) {
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: existingAsset.id
              });
              console.log('Deleted existing asset');
            }
            
            // 上传新文件
            const fs = require('fs');
            const path = require('path');
            const filePath = 'data.unity3d.origin';
            
            if (!fs.existsSync(filePath)) {
              console.log('File not found:', filePath);
              return;
            }
            
            const fileContent = fs.readFileSync(filePath);
            
            await github.rest.repos.uploadReleaseAsset({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release_id,
              name: 'data.unity3d.origin',
              data: fileContent
            });
            
            console.log('Uploaded data.unity3d.origin');

      - name: Delete Assets
        if: github.event.inputs.action == 'delete'
        uses: actions/github-script@v7
        with:
          script: |
            const release_id = ${{ steps.release.outputs.result }};
            const assets = await github.rest.repos.listReleaseAssets({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release_id
            });
            
            for (const asset of assets.data) {
              await github.rest.repos.deleteReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                asset_id: asset.id
              });
              console.log('Deleted asset:', asset.name);
            }
